---
layout: post
title: 字节码文件详解
date: 2024-07-08 20:08 +0800
categories: [Java, JVM]
author: <author_id>  
---

## JVM 的组成

Java 虚拟机主要分为以下几个组成部分：



<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708201451471.png" alt="image-20240708201451471" style="zoom:35%;" />



- 类加载子系统：核心组件类加载器，负责将字节码文件中的内容加载到内存中。
- 运行时数据区：JVM管理的内存，创建出来的对象、类的信息等等内容都会放在这块区域中。
- 执行引擎：包含了即时编译器、解释器、垃圾回收器，执行引擎使用解释器将字节码指令解释成机器码，使用即时编译器优化性能，使用垃圾回收器回收不再使用的对象。

- 本地接口：调用本地使用C/C++编译好的方法，本地方法在Java中声明时，都会带上 native 关键字，如下图所示。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708201654978.png" alt="image-20240708201654978" style="zoom:45%;" />



## 字节码文件的组成

使用 jclasslib 工具查看字节码文件；Github地址： https://github.com/ingokegel/jclasslib

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708202140821.png" alt="image-20240708202140821" style="zoom:45%;" />

字节码文件总共可以分为以下几个部分：

- **基础信息**：魔数、字节码文件对应的Java版本号、访问标识(public final等等)、父类和接口信息；
- **常量池**： 保存了字符串常量、类或接口名、字段名，主要在字节码指令中使用；
- **字段：** 当前类或接口声明的字段信息；
- **方法：** 当前类或接口声明的方法信息，核心内容为方法的字节码指令；
- **属性：** 类的属性，比如源码的文件名、内部类的列表等；



### 基本信息

包含了 jclasslib 中能看到的两块内容：

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708202711822.png" alt="image-20240708202711822" style="zoom:65%;" />

**①  Magic 魔数**

每个 Java 字节码文件的前四个字节是固定的，用16进制表示就是 0xcafebabe。

- 文件是无法通过文件扩展名来确定文件类型的，文件扩展名可以随意修改不影响文件的内容。
- 软件会使用文件的头几个字节（文件头）去校验文件的类型，如果软件不支持该种类型就会出错。
- Java字节码文件中，将文件头称为 magic 魔数。



比如常见的文件格式校验方式如下：

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708203419522.png" alt="image-20240708203419522" style="zoom:40%;" />

**②  主副版本号**

- 主副版本号指的是编译字节码文件的JDK版本号，主版本号用来标识大版本号，JDK1.0-1.1 使用了 45.0-45.3，JDK 1.2 是 46 之后每升级一个大版本就加 1；副版本号是当主版本号相同时作为区分不同版本的标识，一般只需要关心主版本号。

- **版本号的作用主要是判断当前字节码的版本和运行时的JDK是否兼容。**

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708204046906.png" alt="image-20240708204046906" style="zoom:50%;" />

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708204111832.png" alt="image-20240708204111832" style="zoom:50%;" />

对于以下错误，有两种解决方案：

1,  升级JDK版本，将图中使用的JDK6升级至JDK8即可正常运行，容易引发其他的兼容性问题，并且需要大量的测试。

2,  将第三方依赖的版本号降低或者更换依赖，以满足JDK版本的要求。<font color='red'>建议使用这种方案</font>

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708204229535.png" alt="image-20240708204229535" style="zoom:30%;" />



**③  其他基础信息**

其他基础信息包括访问标识、类和接口索引，如下：

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/output.png" alt="output" style="zoom:50%;" />



### 常量池

字节码文件中常量池的作用：避免相同的内容重复定义，节省空间。

- 常量池中的数据都有一个编号，编号从 1 开始。在字段或者字节码指令中通过编号可以快速的找到对应的数据。

- 字节码指令中通过编号引用到常量池的过程称之为 **符号引用**。



### 字段

字段中存放的是当前类或接口声明的字段信息。

如下图中，定义了两个字段 `a1` 和 `a2`，这两个字段就会出现在字段这部分内容中。同时还包含字段的名字、描述符（字段的类型）、访问标识（public/private  static  final等）。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/1108c3bf-f777-47c3-a766-c693984215a5.png" alt="1108c3bf-f777-47c3-a766-c693984215a5" style="zoom:70%;" />

### 方法

字节码中的方法区域是存放 **字节码指令** 的核心位置，字节码指令的内容存放在方法的 Code 属性中。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708210659893.png" alt="image-20240708210659893" style="zoom:50%;" />

```java
int i = 0;
int j = i + 1;
```

上述 java 代码翻译成字节码指令之后如下：

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image%20(1).png" alt="image (1)" style="zoom:45%;" />

要理解这段字节码指令是如何执行的，我们需要先理解两块内存区域：操作数栈和局部变量表。

- **操作数栈** 是用来存放临时数据的内容，是一个栈式的结构，先进后出。

- **局部变量表** 是存放方法中的局部变量，包含方法的参数、方法中定义的局部变量，在编译期就已经可以确定方法有多少个局部变量。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708211413930.png" alt="image-20240708211413930" style="zoom:35%;" />

1、iconst_0：将常量0放入操作数栈。此时栈上只有0。

2、istore_1：会从操作数栈中，将栈顶的元素弹出来，此时0会被弹出，放入局部变量表的1号位置。局部变量表中的1号位置，在编译时就已经确定是局部变量i使用的位置。完成了对局部变量i的赋值操作。

3、iload_1：将局部变量表1号位置的数据放入操作数栈中，此时栈中会放入0。

4、iconst_1：会将常量1放入操作数栈中。

5、iadd：会将操作数栈顶部的两个数据相加，现在操作数栈上有两个数0和1，相加之后结果为1放入操作数栈中，此时栈上只有一个数也就是相加的结果1。

6、istore_2：从操作数栈中将1弹出，并放入局部变量表的2号位置，2号位置是j在使用。完成了对局部变量j的赋值操作。

7、return：语句执行，方法结束并返回。



### 属性

属性主要指的是类的属性，比如源码的文件名、内部类的列表等。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image%20(2).png" alt="image (2)" style="zoom:65%;" />



## 类的生命周期

类的生命周期描述了一个类加载、使用、卸载的整个过程。整体可以分为：

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708211958605.png" alt="image-20240708211958605" style="zoom:35%;" />



### 加载阶段

1、加载(Loading) 阶段第一步是类加载器根据 **类的全限定名** 通过不同的渠道以二进制流的方式获取字节码信息。

程序员可以使用Java代码拓展的不同的渠道。



<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708212136747.png" alt="image-20240708212136747" style="zoom:40%;" />

2、类加载器在加载完类之后，Java 虚拟机会将字节码中的信息保存到方法区中。

生成一个 `InstanceKlass` 对象，保存类的所有信息，里边还包含实现特定功能比如多态的信息。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708212319107.png" alt="image-20240708212319107" style="zoom:35%;" />



3、同时，Java 虚拟机还会在堆中生成一份与方法区中数据类似的 `java.lang.Class` 对象。

作用是在 Java 代码中去获取类的信息以及存储静态字段的数据（JDK8及之后）。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708212800753.png" alt="image-20240708212800753" style="zoom:35%;" />

​	

对于开发者来说，只需要访问堆中的Class对象而不需要访问方法区中所有信息。

这样Java虚拟机就能很好地控制开发者访问数据的范围。



<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708213031190.png" alt="image-20240708213031190" style="zoom:40%;" />



### 连接阶段

连接阶段分为三个子阶段:

- 验证，验证内容是否满足《Java虚拟机规范》。
- 准备，给静态变量赋初值。
- 解析，将常量池中的符号引用替换成指向内存的直接引用。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708213216455.png" alt="image-20240708213216455" style="zoom:35%;" />



**①  验证**

- 验证的主要目的是检测 Java 字节码文件是否遵守了《Java虚拟机规范》中的约束。这个阶段一般不需要程序员参与。

- 主要包含如下四部分，具体详见《Java虚拟机规范》：

​		1，文件格式验证，比如文件是否以 `0xCAFEBABE` 开头，主次版本号是否满足当前Java虚拟机版本要求。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708213426110.png" alt="image-20240708213426110" style="zoom:45%;" />

​		2，元信息验证，例如类必须有父类（super不能为空）。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708213553804.png" alt="image-20240708213553804" style="zoom:70%;" />

​		3，验证程序执行指令的语义，比如方法内的指令执行中跳转到不正确的位置。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708213635806.png" alt="image-20240708213635806" style="zoom:50%;" />

​		4，符号引用验证，例如是否访问了其他类中 `private` 的方法等。

对版本号的验证，在JDK8的源码中如下：

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/(null)" alt="img" style="zoom:30%;" />

编译文件的主版本号不能高于运行环境主版本号，如果主版本号相等，副版本号也不能超过。



**②  准备**

- 准备阶段为 静态变量（static）分配内存并设置初始值，而每一种基本数据类型和引用数据类型都有其初始值。

注意：本章涉及到的内存结构只讨论JDK8及之后的版本，8 之前的版本后续章节详述。



| 数据类型     | 初始值   |
| ------------ | -------- |
| int          | 0        |
| long         | 0L       |
| short        | 0        |
| char         | ‘\u0000’ |
| byte         | 0        |
| boolean      | false    |
| double       | 0.0      |
| 引用数据类型 | null     |

final 修饰的基本数据类型的静态变量，准备阶段直接会将代码中的值进行赋值。

如下例子中，变量加上 final 进行修饰，在准备阶段 value 值就直接变成1了，因为 final 修饰的变量后续不会发生值的变更。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708220813155.png" alt="image-20240708220813155" style="zoom:35%;" />



**③  解析**

- 解析阶段主要是将常量池中的符号引用替换为直接引用；
- 符号引用就是在字节码文件中使用编号来访问常量池中的内容。

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708221113590.png" alt="image-20240708221113590" style="zoom:45%;" />

<img src="../media/2024-07-08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/image-20240708221152697.png" alt="image-20240708221152697" style="zoom:50%;" />



### 初始化阶段









