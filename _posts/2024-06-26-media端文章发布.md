---
layout: post
title: Media端文章发布
date: 2024-06-26 22:11 +0800
categories: [Blogging,TJU-news]
author: <author_id>  
---

## 前后端搭建

### 后台搭建

**依赖关系：**

<img src="../media/2024-06-26-media%E7%AB%AF%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83/image-20240626221645876.png" alt="image-20240626221645876" style="zoom:40%;" />

在项目中分别创建对应的模块；

**Nacos 配置：**

`leadnews-wemedia`

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_wemedia?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC&useSSL=false
    username: ****
    password: ****
# 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # 设置别名包扫描路径，通过该属性可以给包中的类注册别名
  type-aliases-package: com.shawen.model.media.pojos
```

`leadnews-wemedia-gateway`

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # 匹配所有请求
            allowedOrigins: "*" #跨域处理 允许所有的域
            allowedMethods: # 支持的方法
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # 平台管理
        - id: wemedia
          uri: lb://leadnews-wemedia
          predicates:
            - Path=/wemedia/**
          filters:
            - StripPrefix= 1
```



### 前台搭建

通过 `nginx` 的虚拟主机功能，使用同一个 `nginx` 访问多个项目。

<img src="../media/2024-06-26-media%E7%AB%AF%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83/image-20240626222408938.png" alt="image-20240626222408938" style="zoom:35%;" />

在 `nginx` 中 `leadnews.conf` 目录中新增 `TJU-campus-wemedia.conf` 文件

- 网关地址修改（localhost:51602）

- 前端项目目录修改（ wemedia-web 解压的目录）

- 访问端口修改(8802)

```nginx
upstream  heima-wemedia-gateway{
    server localhost:51602;
}

server {
	listen 8802;
	location / {
		root /Users/heshuwen/Documents/01_develop/myProjects/wemedia-web/;
		index index.html;
	}
	
	location ~/wemedia/MEDIA/(.*) {
		proxy_pass http://heima-wemedia-gateway/$1;
		proxy_set_header HOST $host;  # 不改变源请求头的值
		proxy_pass_request_body on;  #开启获取请求体
		proxy_pass_request_headers on;  #开启获取请求头
		proxy_set_header X-Real-IP $remote_addr;   # 记录真实发出请求的客户端IP
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #记录代理信息
	}
}
```



## 素材上传

### 实现思路

**功能展示：**

<img src="../media/2024-06-26-media%E7%AB%AF%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83/image-20240626223448582.png" alt="image-20240626223448582" style="zoom:30%;" />

图片上传的页面，首先是展示素材信息，可以点击图片上传，弹窗后可以上传图片。



**流程图：**

<img src="../media/2024-06-26-media%E7%AB%AF%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83/image-20240626224055949.png" alt="image-20240626224055949" style="zoom:40%;" />

### 实现流程

①：前端发送上传图片请求，类型为  `MultipartFile`；

②：网关进行 `token` 解析后，把解析后的用户信息存储到 `header` 中；

```java
//获得token解析后中的用户信息
Object userId = claimsBody.get("id");
//在header中添加新的信息
ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
    httpHeaders.add("userId", userId + "");
}).build();
//重置header
exchange.mutate().request(serverHttpRequest).build();
```

③：自媒体微服务使用拦截器获取到 `header` 中的的用户信息，并放入到 `threadlocal` 中

在 `TJU-campus-utils` 中新增工具类

```java
public class WmThreadLocalUtil {

    private final static ThreadLocal<WmUser> WM_USER_THREAD_LOCAL = new ThreadLocal<>();

    //存入线程中
    public static void setUser(WmUser wmUser){
        WM_USER_THREAD_LOCAL.set(wmUser);
    }

    //从线程中获取
    public static WmUser getUser(){
        return WM_USER_THREAD_LOCAL.get();
    }

    //清理
    public static void clear(){
        WM_USER_THREAD_LOCAL.remove();
    }

}
```

在 `TJU-campus-wemedia` 中新增拦截器

```java
public class WmTokenInterceptor implements HandlerInterceptor {

    /**
     * 得到header中的用户信息，并且存入到当前线程中
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String userId = request.getHeader("userId");
        if(userId != null){
            //存入到当前线程中
            WmUser wmUser = new WmUser();
            wmUser.setId(Integer.valueOf(userId));
            WmThreadLocalUtil.setUser(wmUser);

        }
        return true;
    }

    /**
     * 清理线程中的数据
     * @param request
     * @param response
     * @param handler
     * @param modelAndView
     * @throws Exception
     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        WmThreadLocalUtil.clear();
    }
}
```

**配置使拦截器生效，拦截所有的请求**

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new WmTokenInterceptor()).addPathPatterns("/**");
    }
}
```

④：先把图片上传到minIO中，获取到图片请求的路径；

⑤：把用户id和图片上的路径保存到素材表中。



### 表结构

媒体图文素材信息表 `wm_material`

<img src="../media/2024-06-26-media%E7%AB%AF%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83/image-20240626223735000.png" alt="image-20240626223735000" style="zoom:45%;" />

**对应实体类：**

```java
@Data
@TableName("wm_material")
public class WmMaterial implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * 自媒体用户ID
     */
    @TableField("user_id")
    private Integer userId;

    /**
     * 图片地址
     */
    @TableField("url")
    private String url;

    /**
     * 素材类型
            0 图片
            1 视频
     */
    @TableField("type")
    private Short type;

    /**
     * 是否收藏
     */
    @TableField("is_collection")
    private Short isCollection;

    /**
     * 创建时间
     */
    @TableField("created_time")
    private Date createdTime;

}
```

### 接口定义

|          |            **说明**             |
| :------: | :-----------------------------: |
| 接口路径 | /api/v1/material/upload_picture |
| 请求方式 |              POST               |
|   参数   |          MultipartFile          |
| 响应结果 |         ResponseResult          |

`MultipartFile`  ：`Springmvc` 指定的文件接收类型；

`ResponseResult`  ：成功需要回显图片，返回素材对象

<img src="../media/2024-06-26-media%E7%AB%AF%E6%96%87%E7%AB%A0%E5%8F%91%E5%B8%83/image-20240627150456307.png" alt="image-20240627150456307" style="zoom:50%;" />

### 自媒体微服务集成 TJU-campus-starter

①：导入 TJU-campus-starter

```xml
<dependencies>
  <dependency>
    <groupId>com.shawen</groupId>
    <artifactId>TJU-campus-starter</artifactId>
    <version>1.0-SNAPSHOT</version>
  </dependency>
</dependencies>
```

②：在自媒体微服务的配置中心添加以下配置：

```yaml
minio:
  accessKey: ****
  secretKey: ****
  bucket: leadnews
  endpoint: http:localhost:9000
  readPath: http:localhost:9000
```

### 接口代码实现

**①：创建 WmMaterialController**

```java
@RestController
@RequestMapping("/api/v1/material")
public class WmMaterialController {

    @Autowired
    private WmMaterialService wmMaterialService;


    @PostMapping("/upload_picture")
    public ResponseResult uploadPicture(MultipartFile multipartFile){
        return wmMaterialService.uploadPicture(multipartFile);
    }
}
```

**②：mapper**

```java
@Mapper
public interface WmMaterialMapper extends BaseMapper<WmMaterial> {
}
```

**③：Service && Impl**

```java
public interface WmMaterialService extends IService<WmMaterial> {

    /**
     * 图片上传
     * @param multipartFile
     * @return
     */
    public ResponseResult uploadPicture(MultipartFile multipartFile);
}
```

```java
@Slf4j
@Service
@Transactional
public class WmMaterialServiceImpl extends ServiceImpl<WmMaterialMapper, WmMaterial> implements WmMaterialService {

    @Autowired
    private FileStorageService fileStorageService;

    /**
     * 图片上传
     * @param multipartFile
     * @return
     */
    @Override
    public ResponseResult uploadPicture(MultipartFile multipartFile) {

        //1.检查参数
        if(multipartFile == null || multipartFile.getSize() == 0){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.上传图片到minIO中
        String fileName = UUID.randomUUID().toString().replace("-", "");
        //aa.jpg
        String originalFilename = multipartFile.getOriginalFilename();
        String postfix = originalFilename.substring(originalFilename.lastIndexOf("."));
        String fileId = null;
        try {
            fileId = fileStorageService.uploadImgFile("", fileName + postfix, multipartFile.getInputStream());
            log.info("上传图片到MinIO中，fileId:{}",fileId);
        } catch (IOException e) {
            e.printStackTrace();
            log.error("WmMaterialServiceImpl-上传文件失败");
        }

        //3.保存到数据库中
        WmMaterial wmMaterial = new WmMaterial();
        wmMaterial.setUserId(WmThreadLocalUtil.getUser().getId());
        wmMaterial.setUrl(fileId);
        wmMaterial.setIsCollection((short)0);
        wmMaterial.setType((short)0);
        wmMaterial.setCreatedTime(new Date());
        save(wmMaterial);

        //4.返回结果

        return ResponseResult.okResult(wmMaterial);
    }
}
```

**⑤：测试**

启动自媒体微服务和自媒体网关，使用前端项目进行测试



## 素材列表

### 接口定义

|          |       **说明**        |
| :------: | :-------------------: |
| 接口路径 | /api/v1/material/list |
| 请求方式 |         POST          |
|   参数   |     WmMaterialDto     |
| 响应结果 |    ResponseResult     |

**WmMaterialDto  ：**

```java
@Data
public class WmMaterialDto extends PageRequestDto {

    /**
     * 1 收藏
     * 0 未收藏
     */
    private Short isCollection;
}
```

**ResponseResult  :**

```json
{
  "host":null,
  "code":200,
  "errorMessage":"操作成功",
  "data":[
    {
    "id":52,
      "userId":1102,
      "url":"http://192.168.200.130:9000/leadnews/2021/04/26/ec893175f18c4261af14df14b83cb25f.jpg",
      "type":0,
      "isCollection":0,
      "createdTime":"2021-01-20T16:49:48.000+0000"
    },
    ....
  ],
  "currentPage":1,
  "size":20,
  "total":0
}
```



### 功能实现

**①：在 WmMaterialController 类中新增方法**

```java
@PostMapping("/list")
public ResponseResult findList(@RequestBody WmMaterialDto dto){
  return wmMaterialService.findList(dto);
}
```

**②：mapper 已定义**

**③：Service && Impl**

在 `WmMaterialService` 中新增方法

```java
/**
     * 素材列表查询
     * @param dto
     * @return
     */
public ResponseResult findList( WmMaterialDto dto);
```

```java
    /**
     * 素材列表查询
     * @param dto
     * @return
     */
    @Override
    public ResponseResult findList(WmMaterialDto dto) {

        //1.检查参数
        dto.checkParam();

        //2.分页查询
        IPage page = new Page(dto.getPage(),dto.getSize());
        LambdaQueryWrapper<WmMaterial> lambdaQueryWrapper = new LambdaQueryWrapper<>();
        //是否收藏
        if(dto.getIsCollection() != null && dto.getIsCollection() == 1){
            lambdaQueryWrapper.eq(WmMaterial::getIsCollection,dto.getIsCollection());
        }

        //按照用户查询
        lambdaQueryWrapper.eq(WmMaterial::getUserId,WmThreadLocalUtil.getUser().getId());

        //按照时间倒序
        lambdaQueryWrapper.orderByDesc(WmMaterial::getCreatedTime);


        page = page(page,lambdaQueryWrapper);

        //3.结果返回
        ResponseResult responseResult = new PageResponseResult(dto.getPage(),dto.getSize(),(int)page.getTotal());
        responseResult.setData(page.getRecords());
        return responseResult;
    }
```

④：在自媒体引导类中加入 `mybatis-plus` 的分页拦截器

```java
@Bean
public MybatisPlusInterceptor mybatisPlusInterceptor() {
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
    return interceptor;
}
```



## 文章管理

















