---
layout: post
title: 06 Kafka 实现文章上下架
date: 2024-06-28 09:56 +0800
categories: [Blogging,TJU-news]
author: <author_id>  
---

## Kafka 实现上下架功能

### 功能分析

<img src="../media/2024-06-28-kafka-%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6/image-20240628100130267.png" alt="image-20240628100130267" style="zoom:45%;" />



**操作：**通过在` Media` 端操作，使得 `Article` 端文章上下架；



<img src="../media/2024-06-28-kafka-%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6/image-20240628100408734.png" alt="image-20240628100408734" style="zoom:40%;" />



**上架：**已发表且已上架的文章可以下架

<img src="../media/2024-06-28-kafka-%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6/image-20240628100744361.png" alt="image-20240628100744361" style="zoom:45%;" />

**下架：**已发表且已下架的文章可以上架

<img src="../media/2024-06-28-kafka-%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6/image-20240628100855110.png" alt="image-20240628100855110" style="zoom:45%;" />

### 具体实现流程

如图为 `Kafka` 在项目中的使用方式，用来实现文章的上下架功能。

<img src="../media/2024-06-28-kafka-%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6/kafka%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="kafka流程图" style="zoom:33%;" />



### 接口定义

|          |        **说明**         |
| :------: | :---------------------: |
| 接口路径 | /api/v1/news/down_or_up |
| 请求方式 |          POST           |
|   参数   |           DTO           |
| 响应结果 |     ResponseResult      |

**DTO：**  

```java
@Data
public class WmNewsDto {
    
    private Integer id;
    /**
    * 是否上架  0 下架  1 上架
    */
    private Short enable;

......
}
```



**ResponseResult：**

<img src="../media/2024-06-28-kafka-%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6/image-20210528112150495.png" alt="image-20210528112150495" style="zoom:70%;" />

## 接口代码实现

### 自媒体端 ——> Producer

**1. Controller 部分：**

```java
@RestController
@RequestMapping("/api/v1/news")
public class WmNewsController {

    @PostMapping("/down_or_up")
    public ResponseResult downOrUp(@RequestBody WmNewsDto dto){
        return wmNewsService.downOrUp(dto);
    }
}
```

**2. Service && impl  部分：**

```java
    public ResponseResult downOrUp(WmNewsDto dto);
```

```java
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;

    /**
     * 文章上下架
     * @param dto
     * @return
     */
    @Override
    public ResponseResult downOrUp(WmNewsDto dto) {
        //1.检查参数
        if(dto.getId() == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.查询文章
        WmNews wmNews = getById(dto.getId());
        if(wmNews == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,"文章不存在");
        }

        //3.判断文章是否已发布
        if(!wmNews.getStatus().equals(WmNews.Status.PUBLISHED.getCode())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID,"当前文章不是发布状态，不能上下架");
        }

        //4.修改文章enable
        if(dto.getEnable() != null && dto.getEnable() > -1 && dto.getEnable() < 2){
            update(Wrappers.<WmNews>lambdaUpdate().set(WmNews::getEnable,dto.getEnable())
                    .eq(WmNews::getId,wmNews.getId()));

            // 发送消息，通知 article 修改文章的配置
						  // 略，如下

        }
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

```

**3. 在自媒体端文章上下架后发送消息**

```java
//发送消息，通知article端修改文章配置
if(wmNews.getArticleId() != null){
    Map<String,Object> map = new HashMap<>();
    map.put("articleId",wmNews.getArticleId());
    map.put("enable",dto.getEnable());
    kafkaTemplate.send(WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC,JSON.toJSONString(map));
}
```

常量类：

```java
public class WmNewsMessageConstants {

    public static final String WM_NEWS_UP_OR_DOWN_TOPIC="wm.news.up.or.down.topic";
}
```



`Common` 中导入 `Kafka` 对应依赖：

```xml
<!-- kafkfa -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-clients</artifactId>
</dependency>
```

在自媒体端的 `nacos` 配置中心配置 `kafka` 的生产者

```yaml
spring:
  kafka:
    bootstrap-servers: url:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
```



### Article端 ——> Consumer

在 `article` 端的 `nacos` 配置中心配置 `kafka` 的消费者

```yaml
spring:
  kafka:
    bootstrap-servers: url:9092
    consumer:
      group-id: ${spring.application.name}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
```



**1. 监听，接收数据**

```java
@Component
@Slf4j
public class ArtilceIsDownListener {

    @Autowired
    private ApArticleConfigService apArticleConfigService;

    @KafkaListener(topics = WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC)
    public void onMessage(String message){
        if(StringUtils.isNotBlank(message)){
            Map map = JSON.parseObject(message, Map.class);
            apArticleConfigService.updateByMap(map);
            log.info("article端文章配置修改，articleId={}",map.get("articleId"));
        }
    }
}
```

**2. Service && impl**

```java
public interface ApArticleConfigService extends IService<ApArticleConfig> {

    /**
     * 修改文章配置
     * @param map
     */
    public void updateByMap(Map map);
}
```

```java
@Service
@Slf4j
@Transactional
public class ApArticleConfigServiceImpl extends ServiceImpl<ApArticleConfigMapper, ApArticleConfig> implements ApArticleConfigService {

    /**
     * 修改文章配置
     * @param map
     */
  
    @Override
    public void updateByMap(Map map) {
        //0 下架 1 上架
        Object enable = map.get("enable");
        boolean isDown = true;
        if(enable.equals(1)){
            isDown = false;
        }
        //修改文章配置
        update(Wrappers.<ApArticleConfig>lambdaUpdate().
              eq(ApArticleConfig::getArticleId,map.get("articleId")).
               set(ApArticleConfig::getIsDown,isDown));
    }
}
```

