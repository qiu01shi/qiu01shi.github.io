---
layout: post
title: 05 延迟任务精准发布文章
date: 2024-06-27 21:44 +0800
categories: [Blogging,TJU-news]
author: <author_id>  
---

## 延迟任务

### 概述

- **定时任务：**有固定周期的，有明确的触发时间
- **延迟队列：**没有固定的开始时间，它常常是由一个事件触发的，而在这个事件触发之后的一段时间内触发另一个事件，任务可以立即执行，也可以延迟



<img src="../media/2024-06-27-%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E7%B2%BE%E5%87%86%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0/image-20240627215052397.png" alt="image-20240627215052397" style="zoom:40%;" />

**应用场景：**

场景一：订单下单之后 30 分钟后，如果用户没有付钱，则系统自动取消订单；如果期间下单成功，任务取消；

场景二：接口对接出现网络问题，1分钟后重试，如果失败，2分钟重试，直到出现阈值终止；



### 技术对比

- **DelayQueue**

`JDK` 自带 `DelayQueue` 是一个支持延时获取元素的阻塞队列， 内部采用优先队列 `PriorityQueue` 存储元素，同时元素必须实现 `Delayed` 接口；在创建元素时可以指定多久才可以从队列中获取当前元素，只有在延迟期满时才能从队列中提取元素

<img src="../media/2024-06-27-%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E7%B2%BE%E5%87%86%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0/image-20240627215353852.png" alt="image-20240627215353852" style="zoom:40%;" />

`DelayQueue` 属于排序队列，它的特殊之处在于队列的元素必须实现 `Delayed` 接口，该接口需要实现 `compareTo` 和 `getDelay` 方法；

`getDelay` 方法：获取元素在队列中的剩余时间，只有当剩余时间为 0 时元素才可以出队列。

`compareTo` 方法：用于排序，确定元素出队列的顺序。

使用 `DelayQueue` 作为延迟任务，如果程序挂掉之后，任务都是放在内存，消息会丢失。



- **RabbitMQ 实现延迟任务**

`TTL`：Time To Live (消息存活时间)；

`死信队列`：Dead Letter Exchange(死信交换机)，当消息成为Dead message后，可以重新发送另一个交换机（死信交换机）；





















